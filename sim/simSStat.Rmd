---
title: "Simulating time-averaged birth-death processes"
author: "A. J. Rominger"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
    pdf_document:
        fig_caption: true
bibliography: sim.bib
---

```{r echo=FALSE}
library(socorro)
setwd('~/Dropbox/Research/paleo_supStat/sim')

sstatSim <- read.csv('simSStat.csv', as.is = TRUE)

## colors for different species diversity values
spp <- unique(sstatSim$S)
nspp <- length(spp)
sppCol <- hsv(seq(0.45, 0.7, length.out = nspp),
              seq(0.5, 1, length.out = nspp),
              seq(1, 0.75, length.out = nspp))

## helper function for plotting *s*uper *s*at *s*imulation
sssPlot <- function(x, y, log, tt, ttlty, ...) {
    plot(sstatSim[, x], sstatSim[, y], log = log, type = 'n',
         xaxt = ifelse(grepl('x', log), 'n', 's'),
         yaxt = ifelse(grepl('y', log), 'n', 's'),
         ...)

    for(j in 1:length(tt)) {
        for(i in unique(sstatSim$S))
            with(sstatSim[sstatSim$S == i & sstatSim$tmax == tt[j], ],
                 points(get(x), get(y), type = 'l', lty = ttlty[j], lwd = 2,
                        col = quantCol(i, sppCol, xlim = range(spp))))
    }

    if(grepl('x', log)) logAxis(1)
    if(grepl('y', log)) logAxis(2)
}
```

Part of our paper depends on the assumption that a birth-death process, when time-averaged, will show an approximately Gaussian distribution of fluctuations between time periods.  This is conveniently proven by [1].  We are interested in how the variances of these time-averaged fluctuations are distributed and how they evolve across taxa.  First we must address the question of how the variance of a time-averaged birth-death process is expected to be distributed.  Using simulations discussed below, I show that the inverse variances of a time-averaged birth-death process will follow a gamma distribution.  In our paper we make the claim that the observed gamma distribution of inverse variances in the fossil record of diversity fluctuations arises from a super-statistical process.  Now that we know a gamma distribution can arise just by time-averaging a birth-death process, how should be best frame our super-statistical argument?  In addition to that big question, are you aware of any published references that show time-averaged birth-death processes have gamma-distributed inverse variances?  In my initial search I couldn't find any.

## Examples of gamma fits

In Figure \ref{fig:egFit} I simulate a few examples of time-averaged birth-death processes and show graphically that their inverse variances are very well fit by a gamma distribution.

First let me explain the simulation approach.  I assume that the fossil record mostly captures lineages in steady state.  Therefore I assume that speciation rate ($\lambda$) equals extinction rate ($\mu$)---call this universal rate $\rho$---and I initiate the process at an 
arbitrary initial number of species $S$ ranging from `r min(sstatSim$S)` to `r max(sstatSim$S)`.  I assume each lineage originated at some time $t_0$ in the past ranging from `r max(sstatSim$tmax)` to `r min(sstatSim$tmax)`.  For each simulation experiment I generate 500 lineages, calculating the inverse variance for each.  I then use these 500 inverse variances to estimate the maximum likelihood parameters (shape $\alpha$ and rate $\beta$) of the gamma distribution:
$$
f(x \mid \alpha, \beta) = \frac{\beta^\alpha}{\Gamma(\alpha)} x^{\alpha-1} e^{-x\beta}
$$

![\label{fig:egFit}Example fits of gamma distribution (red line) to inverse variances of simulated birth-death processes with different parameters (indicated in lower right corner of each plot).](fig_exampleGamma.pdf) 

## The gamma parameters change with the parameters of the birth-death process

In Figures \ref{fig:shape}--\ref{fig:rate} I show how the parameters of the gamma distribution of inverse variances change depending on the underlying birth and death rates. The shape parameter $\alpha$ generally decreases with increasing $\rho$, but for small values of $\rho$ there is a non-monotonic phase in which $\alpha$ first increases (Fig. \ref{fig:shape}).  The more recent the origin of the lineage (i.e. the less time its had to diversify) the more prolonged is this non-monotonic phase (Fig. \ref{fig:shape}).

```{r, fig.width=3, fig.height=2.75, fig.align='center', fig.cap='\\label{fig:shape}Relationship between $\\rho$ and $\\alpha$. Different colors correspond to different initial numbers of species.  Solid line corresponds to $t_0 = 550$, dashed line corresponds to $t_0 = 100$.', echo=FALSE}
par(mar = c(3, 3.1, 0, 0) + 0.5, mgp = c(2.5, 0.75, 0), cex.lab = 1.2)
sssPlot('rho', 'var.shape', log = 'xy', tt = c(100, 550), ttlty = c(3, 1), 
        xlab = expression('Birth-death rate'~rho), ylab = expression('Shape'~alpha))
legend('topright', legend = sapply(spp, function(s) parse(text=list(bquote(S == .(s))))),
       lty = 1, col = sppCol, bty = 'n')
```

The rate parameter $\beta$ generally increases with $\rho$, but there is again a non-monotonic phase for small $\rho$ and older lineages show more a pronounced non-monotonic pattern (Fig. \ref{fig:rate}).

```{r, fig.width=3, fig.height=2.75, fig.align='center', fig.cap = '\\label{fig:rate}Relationship between $\\rho$ and $\\beta$. Colors and line types as in Fig. \\ref{fig:shape}.', echo=FALSE}
par(mar = c(3, 3.1, 0, 0) + 0.5, mgp = c(2.5, 0.75, 0), cex.lab = 1.2)
sssPlot('rho', 'var.rate', log = 'xy', tt = c(100, 550), ttlty = c(3, 1), 
        xlab = expression('Birth-death rate'~rho), ylab = expression('Rate'~beta))
```

Because the simulated birth death process has an absorbing state at $X(t) = 0$ the process will eventually go extinct.  Higher $\rho$ values will cause this to happen more quickly, and thus the overall trend of the fluctuations will be negative over the time period considered.  This pattern is recovered in the simulations and suggests that in these simulation we are primarily observing the decline phase of a lineage and not its growth phase (Fig. \ref{fig:mean}).  This results by imposing an arbitrary initial lineage diversity $S$.

```{r, fig.width=3, fig.height=2.75, fig.align='center', fig.cap = '\\label{fig:mean}Relationship between $\\rho$ and mean fluctuation. Colors and line types as in Fig. \\ref{fig:shape}.', echo=FALSE}
par(mar = c(3, 3.1, 0, 0) + 0.5, mgp = c(2.5, 0.75, 0), cex.lab = 1.2)
sssPlot('rho', 'mean.mean', log = '', tt = c(100, 550), ttlty = c(3, 1),
        xlab = expression('Birth-death rate'~rho), ylab = 'Mean fluctuation')
```

In general the simulations produced realistic within lineage diversities, the maximum and minim diversity values showing a power-law-like relationship with $\rho$ (Fig. \ref{fig:s}).

```{r, fig.width=5.5, fig.height=2.75, fig.align='center', fig.cap = '\\label{fig:s}Relationship between $\\rho$ and diversity within a lineage. Colors and line types as in Fig. \\ref{fig:shape}.', echo=FALSE}
par(mfrow = c(1, 2), mar = c(3, 3.1, 0, 0) + 0.5, mgp = c(2.5, 0.75, 0), cex.lab = 1.2)
sssPlot('rho', 'minS', log = 'xy', tt = c(100, 550), ttlty = c(3, 1), 
        xlab = expression('Birth-death rate'~rho), ylab = 'Minimum diversity', 
        ylim = c(min(sstatSim$minS), max(sstatSim$maxS)))
sssPlot('rho', 'maxS', log = 'xy', tt = c(100, 550), ttlty = c(3, 1), 
        xlab = expression('Birth-death rate'~rho), ylab = 'Maximum diversity',
        ylim = c(min(sstatSim$minS), max(sstatSim$maxS)))
```

The observed life-span of lineages was most accurately captured by assuming an initial diversity of $S \leq 40$ and for birth-death rate values of $\rho \geq 0.25$ (Fig. \ref{fig:ext}).

```{r, fig.width=3, fig.height=2.75, fig.align='center', fig.cap = '\\label{fig:ext}Relationship between $\\rho$ and lineage lifespan. Colors and line types as in Fig. \\ref{fig:shape}.', echo=FALSE}
par(mar = c(3, 3.1, 0, 0) + 0.5, mgp = c(2.5, 0.75, 0), cex.lab = 1.2)
sssPlot('rho', 'endT', log = 'y', tt = 550, ttlty = 1, 
        xlab = expression('Birth-death rate'~rho), ylab = 'Lineage lifespan')
```

## References
1. Keilson, J., & Rao, S. S. (1970). A process with chain dependent growth rate. *Journal of Applied Probability* 7: 699--711.